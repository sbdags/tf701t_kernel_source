<style>
    img {display:none}
    video {display:none}
    canvas {display:none}
</style>
<div id='console'></div>
<canvas id='canvas'></canvas>
<img id='secureImage' />
<img id='insecureImage' />
<video id='secureVideo'></video>
<video id='insecureVideo'></video>
<canvas id='imageCanvas'></canvas>
<canvas id='videoCanvas'></canvas>
<script>
    if (window.layoutTestController) {
        layoutTestController.dumpAsText();
        layoutTestController.waitUntilDone();
    }

    var readyCount = 0;
    var doTest = function() {
        if (++readyCount != 4)
            return;

        testTexture(secureImage, true);
        testTexture(insecureImage, false);
        testTexture(secureVideo, true);
        testTexture(insecureVideo, false);

        imageCtx.drawImage(secureImage, 0, 0, imageCtx.canvas.width, imageCtx.canvas.height);
        testTexture(imageCtx.canvas, true);
        imageCtx.drawImage(insecureImage, 0, 0, imageCtx.canvas.width, imageCtx.canvas.height);
        testTexture(imageCtx.canvas, false);

        videoCtx.drawImage(secureVideo, 0, 0, videoCtx.canvas.width, videoCtx.canvas.height);
        testTexture(videoCtx.canvas, true);
        videoCtx.drawImage(insecureVideo, 0, 0, videoCtx.canvas.width, videoCtx.canvas.height);
        testTexture(videoCtx.canvas, false);

        if (window.layoutTestController)
            layoutTestController.notifyDone();
    };

    var secureImage = document.getElementById('secureImage');
    var insecureImage = document.getElementById('insecureImage');
    var secureVideo = document.getElementById('secureVideo');
    var insecureVideo = document.getElementById('insecureVideo');

    secureImage.addEventListener('load', doTest);
    secureImage.src = '../../resources/redirect.php?url=../local/resources/abe.png';

    insecureImage.addEventListener('load', doTest);
    insecureImage.src = '../../resources/redirect.php?url=http://localhost:8000/local/resources/abe.png';

    secureVideo.addEventListener('loadeddata', doTest);
    secureVideo.src = '../../resources/redirect.php?url=test.mp4';

    insecureVideo.addEventListener('loadeddata', doTest);
    insecureVideo.src = '../../resources/redirect.php?url=http://localhost:8000/resources/test.mp4';

    var gl = document.getElementById('canvas').getContext('experimental-webgl');
    gl.bindTexture(gl.TEXTURE_2D, gl.createTexture());

    var imageCtx = document.getElementById('imageCanvas').getContext('2d');
    var videoCtx = document.getElementById('videoCanvas').getContext('2d');

    var testTexture = function(element, isSecure) {
        var elementType = (isSecure ? 'a secure' : 'an insecure') + ' ' + element;
        try {
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, element);
            assert(isSecure, 'texImage2D did not generate a security error for ' + elementType);
        } catch(e) {
            if (e.message == 'SECURITY_ERR: DOM Exception 18')
                assert(!isSecure, 'texImage2D generated a security error for ' + elementType);
            else
                assert(false, 'texImage2D generated an unexpected error: ' + e);
        }
    }

    var assert = function(assertion, msg) {
        if (assertion)
            print('PASS: ' + msg);
        else
            print('FAIL: ' + msg);
    };

    var print = function(msg) {
        var span = document.createElement('span');
        span.innerHTML = msg + '<br/>';
        document.getElementById('console').appendChild(span);
    };

    print('Verifies that images and videos whose source redirects to a different security origin are treated as insecure.');
    print('');
</script>
