<!DOCTYPE html>
<html>
  <head>
    <title>Out Of Memory crash test</title>
    <script src="resources/webgl-test.js"> </script>
    <script id="vshader" type="x-shader/x-vertex">
        attribute vec3 vPosition;
        attribute vec2 vTexCoord0;
        varying vec2 texCoord;
        void main()
        {
            gl_Position = vec4(vPosition.x, vPosition.y, vPosition.z, 1.0);
            texCoord = vTexCoord0;
        }
    </script>

    <script id="fshader" type="x-shader/x-fragment">
        #ifdef GL_ES
        precision highp float;
        #endif
        uniform sampler2D tex;
        varying vec2 texCoord;
        void main()
        {
            gl_FragColor = texture2D(tex, texCoord);
        }
    </script>

    <script>
        function fail()
        {
            document.getElementById("results").innerHTML = "Test <span style='color:red'>FAILED</span>";
        }
        function pass()
        {
            document.getElementById("results").innerHTML = "Test <span style='color:green'>PASSED</span>";
        }

        function checkGLError()
        {
            var error = gl.getError();
            if (error != gl.NO_ERROR) {
                var str = "GL Error: " + error;
                document.body.appendChild(document.createTextNode(str));
                throw str;
            }
        }

        function init()
        {
            if (window.layoutTestController) {
                layoutTestController.overridePreference("WebKitWebGLEnabled", "1");
                layoutTestController.dumpAsText();
            }
            // Set up a canvas to get image data from
            var canvas2d = document.getElementById("texcanvas");
            var context2d = canvas2d.getContext("2d");
            context2d.fillStyle = 'red';
            context2d.fillRect(0,0,512,512);

            gl = initWebGL("example", "vshader", "fshader", [ "vPosition", "vTexCoord0"], [ 1, 0, 1, 1 ], 100);
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
            var vertexObject = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, vertexObject);
            var vertices = new Float32Array([
                -1,  1, 0,
                -1, -1, 0,
                 1,  1, 0,
                 1, -1, 0,
                 1,  1, 0,
                -1, -1, 0]);
            var texCoords = new Float32Array([
                 0, 1,
                 0, 0,
                 1, 1,
                 1, 0,
                 1, 1,
                 0, 0]);
            g_texCoordOffset = vertices.byteLength;
            gl.bufferData(gl.ARRAY_BUFFER, g_texCoordOffset + texCoords.byteLength, gl.STATIC_DRAW);
            gl.bufferSubData(gl.ARRAY_BUFFER, 0, vertices);
            gl.bufferSubData(gl.ARRAY_BUFFER, g_texCoordOffset, texCoords);
            gl.enableVertexAttribArray(0);
            gl.vertexAttribPointer(0, 3, gl.FLOAT, gl.FALSE, 0, 0);
            gl.enableVertexAttribArray(1);
            gl.vertexAttribPointer(1, 2, gl.FLOAT, gl.FALSE, 0, g_texCoordOffset);

            var textures = [];
            for (var i = 0; i < 2000; i++)  {
                // Create a texture from the canvas's image data
                var tex = gl.createTexture();
                textures[i] = tex;
                gl.bindTexture(gl.TEXTURE_2D, tex);
                gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, context2d.getImageData(0, 0, 512, 512));
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
                g_textureLoc = gl.getUniformLocation(gl.program, "tex");
                gl.uniform1i(g_textureLoc, 0);
                // draw couple of visible triangles. That should ensure we allocated resources if any of them are allocated
                // lazily
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                gl.drawArrays(gl.TRIANGLES, 0, 6);
            }
            //checkGLError();
            // if we didn't crash yet, test is passed
            pass();
       }
    </script>
  </head>
  <body onload="init()">
    <canvas id="texcanvas" width="64px" height="64px"></canvas>
    <canvas id="example" width="64px" height="64px">
    There is supposed to be an example drawing here, but it's not important.
    </canvas>
    <div id="results">Test <span style="color:red">FAILED</span></div>
  </body>
</html>
