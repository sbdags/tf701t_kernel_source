<canvas id='hw-canvas-1' width='300' height='300'></canvas>
<canvas id='sw-canvas' width='170' height='170'></canvas>
<canvas id='hw-canvas-2' width='300' height='300'></canvas>

<script>
if (window.layoutTestController)
    layoutTestController.dumpAsText(true);

var seed = 11835;
var randMax = 45331;
var rand = function() {
    return seed = (43168 * seed + 29601) % randMax;
};
var randColor = function() {
    return 'rgba(' + rand() % 256 + ',' + rand() % 256 + ',' + rand() % 256 + ',' + rand() / (randMax - 1) + ')';
};

var Canvas = function(id) {
    this.canvas = document.getElementById(id);
    this.ctx = this.canvas.getContext('2d');

    this.randRect = function() {
        var w = 1 + rand() % this.canvas.width;
        var h = 1 + rand() % this.canvas.height;
        return {x: (w == this.canvas.width) ? 0 : rand() % (1 + this.canvas.width - w),
                y: (h == this.canvas.height) ? 0 : rand() % (1 + this.canvas.height - h),
                w: w,
                h: h};
    };

    this.fillRect = function(fillStyle, rect) {
        if (!rect)
            rect = this.randRect();
        if (!fillStyle) {
            var middle = {x: rect.x + rect.w / 2, y: rect.y + rect.h / 2};
            var t = rand() / (randMax - 1);
            var start, end;
            if (rand() % 2) {
                start = {x: rect.x + t * rect.w, y: rect.y};
                end = {y: rect.y + rect.h};
                end.x = rect.x + (end.y - rect.y) * (middle.x - rect.x) / (middle.y - rect.y);
            } else {
                start = {x: rect.x, y: rect.y + t * rect.h};
                end = {x: rect.x + rect.w};
                end.y = rect.y + (end.x - rect.x) * (middle.y - rect.y) / (middle.x - rect.x);
            }

            fillStyle = this.ctx.createLinearGradient(start.x, start.y, end.x, end.y);
            fillStyle.addColorStop(0, randColor());
            fillStyle.addColorStop(1, randColor());
        }
        this.ctx.fillStyle = fillStyle;
        this.ctx.fillRect(rect.x, rect.y, rect.w, rect.h);
    };

    this.drawCanvas = function(canvas, srcRect, dstRect) {
        if (!srcRect && !dstRect) {
            srcRect = canvas.randRect();
            dstRect = this.randRect();
        } else if (!dstRect)
            dstRect = srcRect;
        this.ctx.drawImage(canvas.canvas, srcRect.x, srcRect.y, srcRect.w, srcRect.h, dstRect.x, dstRect.y, dstRect.w, dstRect.h);
    };

    this.canvasRect = {x: 0, y: 0, w: this.canvas.width, h: this.canvas.height};
    this.fillRect(undefined, this.canvasRect);
};

var hw1 = new Canvas('hw-canvas-1');
var sw = new Canvas('sw-canvas');
var hw2 = new Canvas('hw-canvas-2');

for (var i = 0; i <= 10; i++) {
    // Test 1: Paint two hw canvases into each other 100 times without crashing.
    for (var i = 0; i < 100; i++) {
        hw1.drawCanvas(hw2);
        hw2.drawCanvas(hw1);
    }

    // Test 2: hw2 should end up green.
    for (var i = 0; i < 1000; i++)
        hw1.fillRect('red');
    hw1.fillRect('green', hw1.canvasRect);
    hw2.drawCanvas(hw1, hw2.canvasRect);
    for (var i = 0; i < 1000; i++)
        hw1.fillRect('red');

    // Test 3: Paint a sw and hw canvas into each other 50 times without crashing.
    for (var i = 0; i < 50; i++) {
        hw1.drawCanvas(sw);
        sw.drawCanvas(hw1);
    }

    // Test 4: hw1 should end up green and sw should end up lime.
    for (var i = 0; i < 500; i++) {
        hw1.fillRect('red');
        sw.fillRect('red');
    }
    for (var i = 0; i < 500; i++)
        hw1.fillRect('red');
    sw.fillRect('green', sw.canvasRect);
    hw1.drawCanvas(sw, sw.canvasRect, hw1.canvasRect);
    for (var i = 0; i < 500; i++)
        sw.fillRect('red');
    sw.fillRect('lime', sw.canvasRect);
}
</script>
