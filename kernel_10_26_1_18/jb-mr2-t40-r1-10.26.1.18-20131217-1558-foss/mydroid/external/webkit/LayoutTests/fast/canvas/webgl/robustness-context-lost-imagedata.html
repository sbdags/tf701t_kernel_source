<html>
<head>
<title>WebGL shader robustness test</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<script src="../../js/resources/js-test-pre.js"></script>
<script src="resources/webgl-test.js"> </script>
<script id="fshader" type="x-shader/x-fragment">
  precision highp float;
  varying vec4 v[8];

  void main() {
    vec4 col = vec4(0.0);
    for (int i = 0; i < 8; i++) {
      col += vec4( sqrt(v[i].x), sqrt(v[i].y), sqrt(v[i].z), sqrt(v[i].w) );
      col += vec4(  tan(v[i].x),  tan(v[i].y),  tan(v[i].z),  tan(v[i].w) );
      col += vec4(  sin(v[i].x),  sin(v[i].y),  sin(v[i].z),  sin(v[i].w) );
      col += vec4(  cos(v[i].x),  cos(v[i].y),  cos(v[i].z),  cos(v[i].w) );
      col += vec4(  log(v[i].x),  log(v[i].y),  log(v[i].z),  log(v[i].w) );
    }
    col = normalize(col);
    gl_FragColor = col;
  }
</script>

<script id="vshader" type="x-shader/x-vertex">
  attribute vec2 pos;
  attribute vec4 att;
  varying   vec4 v[8];

  void main() {
    for (int i = 0; i < 8; i++)
      v[i] = att;
    gl_Position = vec4(pos, 0.0, 1.0);
  }
</script>


<script type="text/javascript">
  if (window.initNonKhronosFramework) {
     initNonKhronosFramework(true);
  }
  window.jsTestIsAsync = true;

  var reps = 300; // amount of triangles drawn is reps * 4 - 2

  var canvas;
  var gl;
  var aVertexPos;
  var aVertexAtt;
  var contextLostEventReceived = false;
  var contextLostChecked = false;
  var pixBuffer = new ArrayBuffer(4);
  var pixUint8 = new Uint8Array(pixBuffer);
  var drawTime;
  var maxDrawSecs = 4;

  var vertexPositionBuffer;

  // fill the viewport multiple times
  var vertices = [
       1.0,  1.0,
      -1.0,  1.0,
       1.0, -1.0,
      -1.0, -1.0,
  ];

  var atts = [
       1.0, 1.0, 1.0, 1.0,
       0.0, 1.0, 1.0, 0.0,
       0.0, 1.0, 1.0, 0.0,
       1.0, 1.0, 1.0, 1.0,
  ];

  // Fill vertices and atts with duplicates of what is already there
  var attsToCopy = atts.length;
  var verticesToCopy = vertices.length;
  var i, j;
  for (i = 0; i < reps - 1; ++i) {
    for (j = 0; j < verticesToCopy; ++j) {
        vertices.push(vertices[j]);
    }
    for (j = 0; j < attsToCopy; ++j) {
        atts.push(atts[j]);
    }
  }

  function drawScene() {
    gl.viewport(0, 0, canvas.width, canvas.height);
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

    gl.bindBuffer(gl.ARRAY_BUFFER, vertexPositionBuffer);
    gl.vertexAttribPointer(aVertexPos, 2, gl.FLOAT, false, 0, 0);

    var attBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, attBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(atts), gl.STATIC_DRAW);
    gl.vertexAttribPointer(aVertexAtt, 4, gl.FLOAT, false, 0, 0);

    var startTime = new Date().getTime();

    gl.drawArrays(gl.TRIANGLE_STRIP, 0, reps * 4); // This draw call should timeout.
    gl.finish();
    var dataURL = canvas.toDataURL();
    document.getElementById('dataurl').textContent = dataURL;

    drawTime = (new Date().getTime() - startTime) / 1000;

    gl.deleteBuffer(attBuffer);

    finishJSTest();
    nonKhronosFrameworkNotifyDone();
  }

  function startDOSTest() {
    canvas = document.getElementById("example");
    gl = initWebGL("example", "vshader", "fshader", [ "pos", "att"], [ 1, 0, 0, 1 ], 1);
    aVertexPos = 0;
    aVertexAtt = 1;

    gl.enableVertexAttribArray(aVertexPos);
    gl.enableVertexAttribArray(aVertexAtt);

    vertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, vertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);

    drawScene();
  }

</script>
</head>

<body onload="startDOSTest();">
    <div id="description"></div>
    <div id="console"></div>
    <div id="dataurl"></div>
    <canvas id="example" style="border: none;" width="2048" height="2048"></canvas>
</body>

<script src="../../js/resources/js-test-post.js"></script>

</html>
